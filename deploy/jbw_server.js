function Libs(){cluster=require("cluster"),http=require("http"),url=require("url"),fs=require("fs"),pg=require("pg")}function Router(){function n(e){console.log("404: Page not found."),e.writeHead(200,{"Content-Type":"text/plain"}),e.write("This is the index page."),e.end()}this.route=function(t,i,o){var s,r=null,c=!0,l=t.substr(t.indexOf("/")+1);l=l.substr(l.indexOf("/")+1),l=l.split("/"),s=t.split("/")[1],console.log('About to route a request for "'+s+'"'),""===s||null===s?(r=views.home)||(c=!1,console.log("Home module not defined")):(r=views[s])||(c=!1,console.log("Could not find a module for "+s)),r&&r.display?r.display(i,l,o):(c=!1,console.log("Module "+s+" does not have a display method!\n error: "+e)),c||((r=views[404])||(r=null,n(i)),r&&r.display?r.display(i,l,o):n(i))}}function JBWLoginForm(e,n){JBWPanel(200,300,0,0,0,0,!1,e,function(t){JBWForm(e,function(i){JBWTextbox(null,null,null,null,null,null,null,e,function(o){JBWTextbox(null,null,null,null,null,null,null,e,function(s){JBWButton("Login",{command:"login",payload:[o.handle,s.handle]},null,null,null,null,0,0,e,function(e){i.children.push(o),i.children.push(s),i.children.push(e),t.children.push(i),n(t)})})})})})}function ClientLibs(){this.insertCSS=function(e){e.write("\n		<!-- JBW CSS -->\n"),e.write('		<link rel="stylesheet" stype="text/css" href="res/css/jbw_css.css" />\n'),e.write('		<link rel="stylesheet" stype="text/css" href="res/css/jquery-ui.min.css" />\n'),e.write('		<link rel="stylesheet" stype="text/css" href="res/css/jquery-ui.structure.min.css" />\n'),e.write('		<link rel="stylesheet" stype="text/css" href="res/css/jquery-ui.theme.min.css" />\n')},this.insertScripts=function(e){e.write("\n		<!-- JBW Client Scripts -->\n"),e.write('		<script src="//ajax.googleapis.com/ajax/libs/webfont/1.5.10/webfont.js"></script>\n'),e.write('		<script lang="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>\n'),e.write('		<script lang="text/javascript" src="res/js/jquery-ui.min.js"></script>\n'),e.write('		<script lang="text/javascript" src="res/js/jbw_client.js"></script>\n')}}function Session(){this.test="TEST TEST 1234"}function Queue(){Function.prototype.partial||(Function.prototype.partial=function(){var e=this,n=Array.prototype.slice.call(arguments);return function(){e.apply(null,n.concat.apply(n,arguments))}});var e=this;this.commands=[],this.push=function(n){e.commands.push(n)},this.execute=function(){console.log("queue #"+e.qid+" testing item #"+e.commands.length),e.commands.length&&(console.log("executing"),e.commands.shift()(e.execute))}}function ApiView(){function e(e,n,t){var i=new Queue;i.push(function(e){JBWMenuBar(null,function(t){n.push({mode:"builder",content:t,parent:1}),console.log("complete adding menu"),e()})}.partial()),i.push(function(e){JBWLoginForm(null,function(t){n.push({mode:"builder",content:t,parent:0}),console.log("complete adding login dialog"),e()})}.partial()),i.push(function(){console.log("returning to message handling loop"),t()}),i.execute()}function n(){return!1}function t(e,n){e.push({action:"alert"}),n()}function i(e,n){e.push({action:"alert"}),n()}var o=(new Session,{start_session:{routine:e,secure:!1}});this.display=function(e,s,r){for(var c=[],l=JSON.parse(r),u=new Queue,a=0;a<l.length;a++){var p=!1;try{p=o[l[a].action].secure?n(l):!0}catch(d){u.push(i.partial(c))}if(p)try{u.push(o[l[a].action].routine.partial(l[a],c))}catch(d){u.push(i.partial(c))}else u.push(t.partial(c))}u.push(function(){e.writeHead(200,{"Content-Type":"text/json"}),c.forEach(function(e){console.log(JSON.stringify(e))}),e.write(JSON.stringify(c)),e.end()}),u.execute()}}function HomeView(){this.display=function(e){var n=new ClientLibs;e.writeHead(200,{"Content-Type":"text/html"}),e.write('<html>\n	<head>\n		<title>JobBook</title>\n	</head>\n	<body onload="jbw_start();">\n'),e.write("		<div class='banner'>\n			<img src='res/images/banner.png' />\n		</div>\n"),n.insertCSS(e),n.insertScripts(e),e.write('		<div class="jbw_workpane"></div>\n'),e.write("	</body>\n</html>"),e.end()}}function NotFoundView(){this.display=function(e){e.writeHead(404,{"Content-Type":"text/plain"}),e.write("Error: Page not found."),e.end()}}function ResourceView(){function e(e){e.writeHead(404,{"Content-Type":"text/plain"}),e.end()}function n(n,t,i){console.log("Opening requested file");var o=null;try{o=fs.createReadStream(t)}catch(s){return e(),void console.log("opening failed.")}console.log("Writing file data"),n.writeHead(200,{"Content-Type":i});try{o.pipe(n)}catch(s){return n.end(),void console.log("streaming failed.")}}this.display=function(t,i){if(null===i||2!=i.length||""===i[0])return void e(t);switch(i[0]){case"css":console.log("serving CSS"),n(t,"./res/"+i[1],"text/css");break;case"js":console.log("serving JS"),n(t,"./res/"+i[1],"text/javascript");break;case"images":console.log("serving image"),n(t,"./res/images/"+i[1],"image/png");break;default:e()}}}function JBWButton(e,n,t,i,o,s,r,c,l,u){JBWRectWidget(t,i,o,s,r,c,l,function(t){t.type="button",t.title=e,t.action=n,u(t)})}function JBWForm(e,n){JBWWidget(e,function(e){e.type="form",n(e)})}function JBWMenuBar(n,t){function i(n,t){var i,o=[],s={},r={DataEntry:"Data Entry",Reports:"Reports",ADP:"ADP",Maintenance:"Maintenance"},c=Object.keys(r),l=function(){Object.keys(r).forEach(function(e){JBWMenuHeading(r[e],n,function(t){console.log('Created heading "'+t+'"'),s[e].forEach(function(e){JBWMenuEntry(e.prompt,{},n,function(e){t.children.push(e)})}),o.push(t)})}),t(o)};i=0,function u(){var n=c[i];console.log('Getting items in menu "'+n+'"'),pg.connect("postgres://jbadmin:pg1pg2!+c0013R@192.168.21.106/jbdev",function(t,o){if(s[n]=[],t)console.log(e);else{var r=o.query("SELECT * FROM screenbuttons WHERE levelname = '"+n+"';");r.on("row",function(e){console.log("Got a row"),s[n].push(e)}),r.on("error",function(e){console.log(e)}),r.on("end",function(){i++,o.end(),i===c.length?l():u()})}})}()}JBWWidget(n,function(e){e.type="menuBar",i(n,function(n){e.children=n,t(e)})})}function JBWMenuEntry(e,n,t,i){JBWWidget(t,function(t){t.type="menuEntry",t.title=e,t.action=n,i(t)})}function JBWMenuHeading(e,n,t){JBWWidget(n,function(n){n.type="menuHeading",n.title=e,t(n)})}function JBWPanel(e,n,t,i,o,s,r,c,l){JBWRectWidget(e,n,t,i,o,s,c,function(e){e.type="panel",e.resizable=r,l(e)})}function JBWRectWidget(e,n,t,i,o,s,r,c){JBWWidget(r,function(r){r.type="rectWidget",r.height=e,r.width=n,r.top=t,r.left=i,r.bottom=o,r.right=s,c(r)})}function JBWTextbox(e,n,t,i,o,s,r,c,l){JBWRectWidget(e,n,t,i,o,s,c,function(e){e.type="textbox",l(e)})}function JBWWidget(e,n){var t={};t.type="widget",t.children=[],n(t)}new Libs;var router=new Router,cpuCount=require("os").cpus().length;if(cluster.isMaster){for(i=0;i<cpuCount;i++)cluster.fork();cluster.on("exit",function(e){var n=e,t=cluster.fork(),i=t.process.pid,o=n.process.pid;console.log("worker "+o+" died."),console.log("worker "+i+" born.")})}else http.createServer(function(e,n){var t="",i=url.parse(e.url).pathname;console.log('Request for "'+i+'" received.'),e.setEncoding("utf8"),e.addListener("data",function(e){t+=e,console.log("Received POST data '"+e+"'")}),e.addListener("end",function(){router.route(i,n,t)})}).listen(8888),console.log("Server has started.");process.on("uncaughtException",function(e){console.error((new Date).toUTCString()+" uncaughtException:",e.message),console.error(e.stack),process.exit(1)});var cluster,http,url,fs,pg,views={home:new HomeView,api:new ApiView,res:new ResourceView,404:new NotFoundView};